# 黄世昌学习 GPIO 模拟串口通信心得

## 一、项目背景

在许多应用场景中，硬件资源有限时，我们可能无法使用硬件串口（UART）进行通信。此时，我们可以使用 GPIO 引脚，通过程序控制其高低电平来模拟串口通信协议。通过这个项目，我学习了如何在 STM32 上使用 **GPIO 模拟串口发送数据**，并实现了从一个开发板向另一个开发板发送 **"Hello World"** 字符串。

## 二、学习过程

### 1. 了解 UART 协议
首先，为了能够模拟串口通信，我需要了解 **UART (Universal Asynchronous Receiver Transmitter)** 的基本工作原理。UART 是一种常用的异步串行通信协议，其基本的传输方式包括：
- **数据位**：通常为 8 位，表示一个字符。
- **起始位**：每个数据帧的开始。
- **停止位**：每个数据帧的结束。
- **校验位**：可选，通常用于检查数据的正确性。

通过查阅相关资料，我了解了 UART 协议如何将字符转换为一系列高低电平（即 0 和 1），以及如何通过不同的波特率来控制数据传输速度。

### 2. 设置 STM32 开发环境
我使用 STM32 开发板进行实践，首先在 **STM32CubeMX** 中配置了时钟系统、GPIO 和定时器等硬件资源。然后使用 **Keil 5** 编写代码。关键的配置步骤如下：
- **GPIO 配置**：选择一根 GPIO 引脚（如 PA9）作为发送引脚。
- **定时器配置**：定时器用来精确控制数据位的发送时序。

### 3. 实现 GPIO 模拟串口发送数据
在没有硬件串口的情况下，我通过 **GPIO 模拟串口** 发送数据。具体步骤如下：
1. **起始位发送**：在每个数据传输开始时，先将数据线拉低，表示起始位。
2. **数据位传输**：逐位发送数据，控制 GPIO 输出高低电平，模拟 UART 的数据位传输。
3. **校验位**：如果需要，可以通过计算奇偶校验位并发送，确保数据的正确性。
4. **停止位传输**：最后，发送停止位（通常为 1），表示数据帧的结束。

为了确保数据传输的稳定性和精确性，我使用了 **定时器中断** 来控制数据传输的时序，保证每一位的传输间隔是精确的。

### 4. 定时器中断的作用
定时器中断是实现 GPIO 模拟串口通信的关键。通过配置定时器定时触发中断，每次中断时就发送一个数据位。具体来说，使用定时器来设定波特率（例如 115200），并在每个时钟周期中发送一个比特。

我通过 **TIM2** 定时器的中断服务程序（ISR）来处理数据的发送，每个数据位的传输周期就是定时器的一个计数周期。当定时器溢出时，通过中断触发发送下一位数据，直到整个数据帧（包括起始位、数据位、校验位和停止位）发送完毕。

### 5. 调试与验证
为了确保发送的数据正确，我使用了 **串口助手** 或 **另一个 STM32 开发板** 作为接收端进行数据验证。如果接收到的数据与发送的内容一致，且接收端的 LED 状态发生变化（即正确接收到数据后 LED 翻转），则说明模拟串口通信成功。

## 三、遇到的挑战

在学习和实现过程中，我遇到了以下几个挑战：

1. **精确控制波特率**：
   - 模拟串口需要精确的定时控制，尤其是波特率的计算。为了确保数据位的传输速度正确，我需要通过 STM32 的定时器配置来精确控制每个位的传输时间。
   - 例如，如果系统时钟为 48 MHz，波特率为 115200，那么每个位的传输时间就为 `1 / 115200` 秒。因此，我需要根据系统时钟来配置定时器的预分频和计数周期。

2. **中断管理**：
   - 使用定时器中断来发送数据时，必须合理处理中断服务程序，确保在每个中断周期内处理一位数据。过多的操作可能导致延迟，影响传输的准确性。
   
3. **数据对齐与校验**：
   - 在模拟串口传输过程中，数据的对齐和校验非常重要。如果数据帧对齐不正确，或者校验位错误，接收端无法正确解析数据。因此，在实现过程中，我仔细检查了每一位数据的发送顺序，以及如何计算和发送奇偶校验位。

## 四、解决方法

1. **定时器配置优化**：
   - 我调整了定时器的时钟源、预分频值和自动重装载值，以确保每个位的传输时间精确。
   - 我还通过调试输出和示波器观察了波形，确保波特率符合要求。

2. **优化中断处理**：
   - 在中断服务程序中，我避免了过多的运算，确保每次中断时只执行最必要的操作，以减少延迟并保证数据的稳定传输。

3. **数据校验**：
    - 我加入了奇偶校验位，并确保数据帧的起始位和停止位正确，以提高数据传输的可靠性。

## 五、总结与收获

通过这次学习和实践，我掌握了如何使用 **GPIO 模拟串口通信**，并加深了对串口协议和定时器中断的理解。以下是我在这次学习中的一些收获：

- **GPIO 控制**：学会了如何使用 STM32 的 GPIO 来实现低级别的硬件控制，尤其是在没有硬件串口时，通过软件实现串口通信。
- **定时器应用**：学会了如何使用定时器精确控制数据传输的时序，确保模拟串口通信能够按照设定的波特率进行。
- **调试技巧**：通过调试工具（如串口助手和示波器），我能够实时观察和分析数据传输情况，从而验证通信是否正确。

虽然模拟串口通信有一定的复杂性，但它让我更加深入地了解了嵌入式系统中的硬件与软件协作原理，提升了我的开发技能。希望未来能在更复杂的应用中，将这些知识应用到实际项目中。


https://github.com/user-attachments/assets/e6eb33e0-c2b8-483f-bfff-33d7407390a0


